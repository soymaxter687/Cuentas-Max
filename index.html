<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta tus servicios</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      width: 100%;
      max-width: 1000px;
      margin: 30px auto;
      padding: 20px;
      background-color: #f0f4f8;
      color: #333;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #005f99;
    }

    label, select, input, button {
      font-size: 1rem;
      margin: 15px 0;
      display: block;
      width: 100%;
    }

    input, select {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #005fa3;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #0077cc;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f9ff;
    }

    #mensaje {
      color: red;
      font-weight: bold;
      margin-top: 15px;
      text-align: center;
    }

    #resultado {
      margin-top: 20px;
      overflow-x: auto;
      max-width: 100%;
    }
  </style>
</head>
<body>

<h1>Consulta tus servicios</h1>

<label for="pais">Selecciona país:</label>
<select id="pais">
  <option value="+52">México (+52)</option>
  <option value="+1">Estados Unidos (+1)</option>
</select>

<label for="telefono">Ingresa tu número de teléfono (sin espacios ni guiones):</label>
<input type="text" id="telefono" placeholder="Ejemplo: 9811345643" />

<label for="codigo">Ingresa tu código de seguridad (4 dígitos):</label>
<input type="text" id="codigo" placeholder="Ejemplo: 1234" maxlength="4" />

<button id="btnConsultar">Consultar</button>

<div id="mensaje"></div>
<div id="resultado"></div>

<script>
  const SHEET_ID = "1h_7VVQfD3-xP8Gn8QhTqT2oGLd4tccE7tg8oPkHHTgo";
  const SHEET_NAME = "Todos los contactos";
  const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

  // Función para formatear fechas como "17 de enero de 2025"
  function formatearFecha(texto) {
    const partes = texto.split('/');
    if (partes.length !== 3) return texto;

    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10) - 1; // enero = 0
    const año = parseInt(partes[2], 10);

    const fecha = new Date(año, mes, dia);
    return fecha.toLocaleDateString('es-MX', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  document.getElementById('btnConsultar').addEventListener('click', async () => {
    const pais = document.getElementById('pais').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    const mensajeDiv = document.getElementById('mensaje');
    const resultadoDiv = document.getElementById('resultado');
    mensajeDiv.textContent = "";
    resultadoDiv.innerHTML = "";

    if (!telefono.match(/^\d+$/) || !codigo.match(/^\d{4}$/)) {
      mensajeDiv.textContent = "Verifica que el teléfono y el código de seguridad sean válidos.";
      return;
    }

    const telefonoCompleto = pais + telefono;

    try {
      const res = await fetch(URL);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
      const data = JSON.parse(jsonStr);
      const rows = data.table.rows;
      const cols = data.table.cols.map(c => c.label);

      const getCellValue = (row, colName) => {
        const idx = cols.indexOf(colName);
        if (idx === -1) return "";
        const cell = row.c[idx];
        if (!cell) return "";
        if (cell.f) return formatearFecha(cell.f); 
        return cell.v || "";
      };

      // Filtramos tanto por el teléfono como por el código de seguridad
      const clientes = rows.map(row => {
        return {
          Nombre: getCellValue(row, "Nombre") + " " + getCellValue(row, "Apellidos"),
          NumeroTelefono: getCellValue(row, "Número de teléfono").toString().replace(/\s+/g, ''),
          CorreoCuenta: getCellValue(row, "Correo de la cuenta"),
          Contrasena: getCellValue(row, "Contraseña"),
          Servicio: getCellValue(row, "Servicio"),
          Usuario: getCellValue(row, "Usuario"),
          FechaVencimiento: getCellValue(row, "Fecha de vencimiento"),
          PIN: getCellValue(row, "PIN"),
          Codigo: getCellValue(row, "Número de fax"),
          Precio: getCellValue(row, "Precio")
        };
      }).filter(c => c.NumeroTelefono === telefonoCompleto && c.Codigo === codigo);

      if (clientes.length === 0) {
        mensajeDiv.textContent = "No se encontró ningún cliente con ese número y código.";
        return;
      }

      let tablaHTML = `
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Servicio</th>
              <th>Correo</th>
              <th>Contraseña</th>
              <th>Usuario</th>
              <th>Vencimiento</th>
              <th>PIN</th>
              <th>Precio ($)</th>
            </tr>
          </thead>
          <tbody>
      `;

      clientes.forEach(cliente => {
        let correoMostrar = cliente.CorreoCuenta;
        let contrasenaMostrar = cliente.Contrasena;

        if (cliente.Servicio.toLowerCase() === "youtube" || cliente.Servicio.toLowerCase() === "spotify") {
          correoMostrar = cliente.Usuario || cliente.CorreoCuenta || "-----";
          contrasenaMostrar = "-----";
        }

        tablaHTML += `
          <tr>
            <td>${cliente.Nombre}</td>
            <td>${cliente.Servicio}</td>
            <td>${correoMostrar}</td>
            <td>${contrasenaMostrar}</td>
            <td>${cliente.Usuario}</td>
            <td>${cliente.FechaVencimiento}</td>
            <td>${cliente.PIN}</td>
            <td>${cliente.Precio}</td>
          </tr>
        `;
      });

      tablaHTML += `</tbody></table>`;
      resultadoDiv.innerHTML = tablaHTML;

    } catch (e) {
      mensajeDiv.textContent = "Error al consultar los datos. Intenta de nuevo más tarde.";
      console.error(e);
    }
  });
</script>

</body>
</html>
